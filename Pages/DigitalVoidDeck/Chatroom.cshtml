@page
@model KampongTalk.Pages.DigitalVoidDeck.ChatroomModel
@{
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
</div>             

<div class="container">
    <div id="userinfo" class="row">
        <label for="username">Please input your username</label>
        <input type="text" class="form-control" id="username" autocomplete="off" />
        <button type="button" class="btn btn-block" onclick="SetUsername();">Join</button>

    </div>
    <hr />
    <div id="messagearea" class="row" style="display: none; overflow-y: scroll; height: 530px">
        <div><b>You have successfully entered the chat!</b></div>

        <div class="row">
            <div class="col-6">
                <ul id="messageList"></ul>
            </div>
        </div>


    </div>
    <hr />
    <div class="messageinputbox" id="messageinput" style="display: none;">
        <input type="text" id="message" placeholder="Enter your message" style='width: 89%; height: 50px; font-size: 20pt;' autocomplete="off" />
        <input type="button" id="sendButton" style='width:10%; height: 50px; font-size: 20pt;' value="Send" />
    </div>
</div>

<script src="~/js/signalr.js"></script>
<script>

    "use strict";

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
    var username = "";

    //Disable send button until connection is established
    document.getElementById("sendButton").disabled = true;

    connection.on("ReceiveMessage", function (user, message) {
        // encode message
        var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        if (user == document.getElementById("username").value) {
            var li = document.createElement("div");
            
            var liMsg = document.createElement("div");
            li.setAttribute("class", "message-box-holder");
            liMsg.setAttribute("class", "message-box");
            liMsg.textContent = msg;
            li.appendChild(liMsg);
            document.getElementById("messageList").appendChild(li);
        }
        else {
            var li = document.createElement("div");
            var liName = document.createElement("div");
            var liMsg = document.createElement("div");
            li.setAttribute("class", "message-box-holder");
            liName.setAttribute("class", "message-sender");
            liMsg.setAttribute("class", "message-box message-partner");
            liName.textContent = user;
            liMsg.textContent = msg;
            li.appendChild(liName);
            li.appendChild(liMsg);
            document.getElementById("messageList").appendChild(li);
        }
    });
    
    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
    }).catch(function (err) {
        return console.error(err.toString());
    });

    document.getElementById("sendButton").addEventListener("click", function (event) {
        var message = document.getElementById("message").value;
        connection.invoke("SendMessage", username, message).then(function () {
            document.getElementById("message").value = "";
        }).catch(function (err) {
            return console.error(err.toString());
        });
        event.preventDefault();
    });

    function SetUsername() {
        // check the username
        var usernameinput = document.getElementById("username").value;
        if (usernameinput === "") {
            alert("please enter your user name");
            return;
        }
        username = usernameinput;

        // hide username div and show message panel.
        document.getElementById("userinfo").style.display = 'none';
        document.getElementById("messagearea").style.display = 'block';
        document.getElementById("messageinput").style.display = 'block';
        document.getElementById("username1").innerText = usernameinput;

    }
</script>

<style>


    .message-box-holder {
        width: 100%;
        margin: 0 0 15px;
        display: flex;
        flex-flow: column;
        align-items: flex-end;
    }

    .message-sender {
        font-size: 17px;
        margin: 0 0 15px;
        color: #30649c;
        align-self: flex-start;
    }

        .message-sender a, .message-sender a:link, .message-sender a:visited, .chat-partner-name a, .chat-partner-name a:link, .chat-partner-name a:visited {
            color: #30649c;
            text-decoration: none;
        }

    .message-box {
        padding: 6px 10px;
        border-radius: 6px 0 6px 0;
        position: relative;
        background: rgba(100, 170, 0, .1);
        border: 2px solid rgba(100, 170, 0, .1);
        color: #6c6c6c;
        font-size: 20px;
    }

        .message-box:after {
            content: "";
            position: absolute;
            border: 10px solid transparent;
            border-top: 10px solid rgba(100, 170, 0, .2);
            border-right: none;
            bottom: -22px;
            right: 20px;
        }

    .message-partner {
        background: rgba(0, 114, 135, .1);
        border: 2px solid rgba(0, 114, 135, .1);
        align-self: flex-start;
    }

        .message-partner:after {
            right: auto;
            bottom: auto;
            top: -22px;
            left: 9px;
            border: 10px solid transparent;
            border-bottom: 10px solid rgba(0, 114, 135, .2);
            border-left: none;
        }


    div.messageinputbox {
        position: relative;
        

    }

</style>